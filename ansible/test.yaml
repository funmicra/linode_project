---
- name: Setup funmicra user and ZeroTier VPN
  hosts: all
  become: yes
  vars:
    zerotier_network_id: "YOUR_ZEROTIER_NETWORK_ID"  # replace with your network ID
    funmicra_password: "{{ 'password' | password_hash('sha512') }}"
    ssh_keys_file: "./ssh.keys"  # path to your public keys file

  tasks:
    - name: Ensure funmicra user exists
      user:
        name: funmicra
        password: "{{ funmicra_password }}"
        shell: /bin/bash
        groups: sudo
        append: yes
        create_home: yes

    - name: Set authorized_keys for funmicra
      authorized_key:
        user: funmicra
        state: present
        key: "{{ item }}"
      loop: "{{ lookup('file', ssh_keys_file).splitlines() }}"

    - name: Disable root login
      user:
        name: root
        shell: /usr/sbin/nologin
        password_lock: yes

    - name: Harden SSHD config
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        backrefs: yes
      loop:
        - { regexp: '^PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^PubkeyAuthentication', line: 'PubkeyAuthentication yes' }

    - name: Restart SSH to apply changes
      service:
        name: ssh
        state: restarted

    - name: Install prerequisites for ZeroTier
      apt:
        name: curl
        state: present
        update_cache: yes

    - name: Install ZeroTier
      shell: curl -s https://install.zerotier.com | bash
      args:
        creates: /var/lib/zerotier-one

    - name: Ensure ZeroTier service is running
      service:
        name: zerotier-one
        state: started
        enabled: yes

    - name: Join ZeroTier network
      shell: zerotier-cli join {{ zerotier_network_id }}
      register: join_result
      changed_when: "'200 join OK' in join_result.stdout"

    - name: Show ZeroTier info
      shell: zerotier-cli info
      register: zt_status

    - debug:
        msg: "{{ zt_status.stdout }}"
